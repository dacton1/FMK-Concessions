<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Concessions Menu</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: white;
      color: black;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      display: flex;
      justify-content: center;
      align-items: center;
      background: red;
      color: white;
      padding: 10px;
    }
    header img {
      height: 80px;
      margin-right: 15px;
    }
    h1 {
      font-size: 3em;
      margin: 0;
    }
    .category {
      margin: 30px auto;
      padding: 10px 20px;
      max-width: 1000px;
      border-top: 4px solid black;
    }
    .category h2 {
      background: black;
      color: white;
      padding: 10px;
      margin: 0 0 20px;
      font-size: 2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.8em;
    }
    td {
      padding: 12px;
      text-align: left;
    }
    td.price {
      text-align: right;
      font-weight: bold;
    }
    .notes {
      font-size: 0.6em;
      color: #333;
      margin-top: 5px;
    }
    .soldout {
      font-weight: bold;
      color: white;
      background: red;
      padding: 3px 8px;
      border-radius: 5px;
      margin-left: 10px;
      animation: flash 0.8s ease-in-out;
    }
    @keyframes flash {
      0% { opacity: 0; }
      25% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    footer {
      margin-top: 40px;
      padding: 20px;
      border-top: 4px solid black;
    }
    .bottom-logos {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      align-items: center;
    }
    .bottom-logos img {
      height: 50px;
    }
    .qrcode {
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <header>
    <img src="Knights logo 1.png" alt="Knights Logo"/>
    <h1>Concessions Menu</h1>
  </header>

  <div id="menu"></div>

  <footer>
    <div class="qrcode">
      <p>Scan to view this menu on your phone:</p>
      <canvas id="qr"></canvas>
    </div>
    <div class="bottom-logos">
      <img src="creditcards.png" alt="Credit Cards Accepted"/>
      <img src="venmo.png" alt="Venmo Accepted"/>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    const SHEET_ID = "1SCplGSlgFs4jHvPhj2mVwToWkQknWmeevnxE1wss970";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

    let previousData = null;

    async function fetchData() {
      try {
        const response = await fetch(SHEET_URL);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));

        const rows = json.table.rows.map(r =>
          r.c.map(c => (c ? c.v : ""))
        );

        const headers = json.table.cols.map(c => c.label);
        const items = rows.map(row => {
          let obj = {};
          headers.forEach((h, i) => {
            obj[h] = row[i];
          });
          return obj;
        });

        localStorage.setItem("cachedMenu", JSON.stringify(items));
        renderMenu(items);

      } catch (e) {
        console.warn("Fetch failed, using cached menu", e);
        const cached = localStorage.getItem("cachedMenu");
        if (cached) {
          renderMenu(JSON.parse(cached));
        } else {
          document.getElementById("menu").innerHTML = "<p>Menu unavailable</p>";
        }
      }
    }

    function renderMenu(items) {
      // Filter out items not for this event
      items = items.filter(i => i["Sell at This Event"] === "Yes");

      // Group by category
      let categories = {};
      items.forEach(item => {
        const category = item.Category || "Other";
        if (!categories[category]) categories[category] = [];
        categories[category].push(item);
      });

      // Sort within category by Priority in Category
      for (let cat in categories) {
        categories[cat].sort((a, b) =>
          (a["Priority in Category"] || 999) - (b["Priority in Category"] || 999)
        );
      }

      let newData = JSON.stringify(items);
      if (newData === previousData) return; // no change → don’t redraw
      previousData = newData;

      let html = "";
      for (let cat in categories) {
        html += `<div class="category"><h2>${cat}</h2><table>`;
        categories[cat].forEach(item => {
          let price1 = item["Price for 1"] ? parseFloat(item["Price for 1"]).toFixed(2) : "";
          let price2 = item["Price for 2"] ? parseFloat(item["Price for 2"]).toFixed(2) : "";
          let priceDisplay = price1 && price2 ? `$${price1} / $${price2}` : (price1 ? `$${price1}` : "");

          let soldOut = item["Sold Out"] === "Yes";
          let notes = item["Notes"] || "";

          html += `<tr>
            <td>
              ${item.Item}
              ${soldOut ? `<span class="soldout">SOLD OUT</span>` : ""}
              ${notes ? `<div class="notes">${notes}</div>` : ""}
            </td>
            <td class="price">${!soldOut ? priceDisplay : ""}</td>
          </tr>`;
        });
        html += `</table></div>`;
      }
      document.getElementById("menu").innerHTML = html;
    }

    // Generate QR code linking to GitHub Pages menu
    QRCode.toCanvas(document.getElementById("qr"), window.location.href, { width: 150 });

    fetchData();
    setInterval(fetchData, 10000); // refresh every 10s
  </script>
</body>
</html>
